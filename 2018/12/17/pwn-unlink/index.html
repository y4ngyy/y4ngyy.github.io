<!doctype html>
<html lang="en">
<head>
    <head>
    <!-- Require Meta -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!-- Font-awsome CSS-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <!-- hightlight.js -->
    <link rel="stylesheet" href="/css/style.css">
    <link type="icon" href="/images/favicon.ico">
    <!-- title -->
    <title>y4ngyy</title>
</head>
</head>
<body>
<div class="sidebar-container">
<div class="sidebar rounded">
    <!--头像区域-->
    <div class="head bg-dark text-center rounded-bottom">
        <a href="#">
            <img src="/images/avatar.jpg" alt="avatar.jpg">
        </a>
        <h2 class="text-light mt-4">y4ngyy</h2>
    </div>
    <!--个人描述-->
    <section class="text-center text-dark p-lg-5 p-3" id="description"><h4 class="m-0">无所事事,游手好闲</h4></section>
    <!--导航条-->
    <nav>
        <p  class="nav-clapse fa fa-bars text-center"></p>
        <ul class="nav flex-column text-center">
            
            <li class="nav-item">
                <a href="/" class="nav-link text-secondary">Home</a>
            </li>
            
            <li class="nav-item">
                <a href="/archives" class="nav-link text-secondary">Archives</a>
            </li>
            
        </ul>
    </nav>
</div>
</div>
<div class="content-container">
    <div class="content shadow rounded">
        <h2 class="text-center">【PWN】unlink exploit</h2>
        <div class="text-center">
            <i class="fa fa-calendar"></i>
            <span>2018-12-17</span>
        </div>
        <hr width="90%" color="#ddd">
        <article>
                <h2 id="堆机制"><a href="#堆机制" class="headerlink" title="堆机制"></a>堆机制</h2><p>当一个<strong>small chunk</strong>被free掉时，会有如下操作：</p>
<ol>
<li><p>检查是否能向后合并，如果相邻低位的chunk也处于被free的状态，则向后合并。</p>
<ul>
<li>合并两个chunk的内存</li>
<li>修改当前chunk指针为前一个chunk指针</li>
<li>触发<strong>unlink操作</strong>将前一个chunk从双向链表(bin)中移除</li>
</ul>
</li>
<li><p>检查是否能向前合并，如果相邻高位的chunk处于被free的状态，则向前合并，同样能出发<strong>unlink 操作</strong>。</p>
</li>
</ol>
<p><strong>unlink</strong>的操作为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unlink_chunk</span> <span class="params">(mstate av, mchunkptr p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">"corrupted size vs. prev_size"</span>);</span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">"corrupted double-linked list"</span>);</span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">          || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">        malloc_printerr (<span class="string">"corrupted double-linked list (not small)"</span>);</span><br><span class="line">      <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">            fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">              fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">              p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">              p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">          p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中重要的操作为：(主要就是将chunk从双向链表中移除)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr fd = p-&gt;fd;</span><br><span class="line">mchunkptr bk = p-&gt;bk;</span><br><span class="line">fd-&gt;bk = bk;</span><br><span class="line">bk-&gt;fd = fd;</span><br></pre></td></tr></table></figure>
<p>还有需要注意的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">"corrupted size vs. prev_size"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">"corrupted double-linked list"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>由于有了检查机制，所以unlink所能做的操作有所限制。具体操作为：</p>
<ol>
<li>构造<code>p-&gt;fd=(p)-12</code>,<code>p-&gt;bk=(p)-8</code></li>
<li>触发unlink(p)</li>
<li>于是unlink操作变为了 <code>(p)=(p)-8</code> =&gt; <code>(p)=(p)-12</code></li>
</ol>
<p>所以最终结果为<code>(p)</code>指针-12，<code>(p)</code>可以是任何存放p指针的地方。<br>虽然操作有限，但在一些场合下可以与<strong>堆溢出</strong>，<strong>user after free</strong>等配合，从而任意地址写。</p>

        </article>
        <hr width="90%" color="#ddd">
    </div>
    <div class="content text-center mb-2"><span>Powered By Hexo | theme: <a href="y4ngyy.xyz">y4ngyy</a></span></div>
<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script src="/js/highlight.pack.js"></script>
<script src="/js/nav.js"></script>
<script>
    $(document).ready(function() {
        $('figure').each(function(i, block) {
            hljs.highlightBlock(block);
        });
    });
</script>
</div>
</body>
</html>