<!doctype html>
<html lang="en">
<head>
    <head>
    <!-- Require Meta -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!-- Font-awsome CSS-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <!-- hightlight.js -->
    <link rel="stylesheet" href="/css/style.css">
    <link type="icon" href="/images/favicon.ico">
    <!-- title -->
    <title>y4ngyy</title>
</head>
</head>
<body>
<div class="sidebar-container">
<div class="sidebar rounded">
    <!--头像区域-->
    <div class="head bg-dark text-center rounded-bottom">
        <a href="#">
            <img src="/images/avatar.jpg" alt="avatar.jpg">
        </a>
        <h2 class="text-light mt-4">y4ngyy</h2>
    </div>
    <!--个人描述-->
    <section class="text-center text-dark p-lg-5 p-3" id="description"><h4 class="m-0">无所事事,游手好闲</h4></section>
    <!--导航条-->
    <nav>
        <p  class="nav-clapse fa fa-bars text-center"></p>
        <ul class="nav flex-column text-center">
            
            <li class="nav-item">
                <a href="/" class="nav-link text-secondary">Home</a>
            </li>
            
            <li class="nav-item">
                <a href="/archives" class="nav-link text-secondary">Archives</a>
            </li>
            
        </ul>
    </nav>
</div>
</div>
<div class="content-container">
    <div class="content shadow rounded">
        <h2 class="text-center">堆的理解</h2>
        <div class="text-center">
            <i class="fa fa-calendar"></i>
            <span>2018-12-14</span>
        </div>
        <hr width="90%" color="#ddd">
        <article>
                <p>参考hac师傅的<a href="https://www.cnblogs.com/hac425/p/9416792.html" target="_blank" rel="noopener">博客</a>和<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/introduction/" target="_blank" rel="noopener">CTF-wiki</a>自己总结一下。理解有误，请多指正。</p>
<h2 id="堆块概念"><a href="#堆块概念" class="headerlink" title="堆块概念"></a>堆块概念</h2><p>堆为程序运行时可以由程序动态申请的<strong>线性</strong>内存区域，由低地址向高地址增长（栈为从高到低），在C语言中可以通过<code>malloc</code>和<code>free</code>进行堆块申请和释放操作。</p>
<h2 id="堆块机制"><a href="#堆块机制" class="headerlink" title="堆块机制"></a>堆块机制</h2><p>堆分配中以chunk为单位，其中chunk的数据结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>prev_size</code>：当前一个堆块为<code>free</code>状态时，存放前一个堆块的大小。在前一个堆块不处于空闲状态时，数据为前一个堆块中用户写入的数据，本字段不计入chunk的大小计算。<br><code>size</code>：本堆块的大小，计算方法为<code>size字段(32位为4|64位为8)+用户申请的大小+对齐</code>，32位下对8对齐，64位下对16对齐。且chunk地址的偏移为相邻上一个chunk的地址+上一个chunk的size。在pwndbg中调试好像会加上一位<strong>PREV_INUSE</strong>。<br><code>fb&amp;bk</code>：当chunk为<code>free</code>的状态时，分别指向chunk所在单向链表中的前一个chunk和后一个chunk。在被分配状态时，均用来存储数据，<code>fb</code>为存储数据的开始位置。<br><code>fb_nextsize&amp;bk_nextsize</code>：在被分配状态时也用来存储数据，在<code>free</code>状态时只在large bin中用到，目前没有用，等用到了再总结。</p>
<h2 id="堆块分配机制"><a href="#堆块分配机制" class="headerlink" title="堆块分配机制"></a>堆块分配机制</h2><h3 id="Bins"><a href="#Bins" class="headerlink" title="Bins"></a>Bins</h3><blockquote>
<p>A bin is a list (doubly or singly linked list) of free (non-allocated) chunks.</p>
</blockquote>
<p>bin为一个单向或者双向链表存放空闲的chunk，下一次分配时，若bin中有大小合适的chunk会直接分配出去。bin由存放其中的chunk大小分类为<code>fastbin</code>、<code>smallbin</code>、<code>largebin</code>。<br>比较常用的是<strong>fastbin</strong>，在32位系统下fastbin主要存储0-80字节的chunk，在64位系统下存储0-160字节的chunk。<br>其中还有一个<code>unsorted bin</code>，是当<code>small chunk</code>或<code>large chunk</code>free掉之后，不会直接进入smallbin或largebin，而是会先进入unsortedbin</p>
<h3 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h3><p>个人理解arena为chunk的存储组织形式，在arena的最上层始终为<strong>Top chunk</strong>，向下分出用户chunk，其中主线程中的arena为main arena。</p>
<h3 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h3><p>top chunk为arena的边界，当bin中无合适的chunk分配时，会将top chunk分出一部分进行分配。<br>当与top chunk相邻的chunk处于free状态时，该chunk不会进入bin中，而是会合并入top chunk。</p>
<h2 id="补充知识点"><a href="#补充知识点" class="headerlink" title="补充知识点"></a>补充知识点</h2><ol>
<li><code>malloc</code>返回的是chunk的fd指针，也就是在调试时heap地址+8.</li>
</ol>

        </article>
        <hr width="90%" color="#ddd">
    </div>
    <div class="content text-center mb-2"><span>Powered By Hexo | theme: <a href="y4ngyy.xyz">y4ngyy</a></span></div>
<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script src="/js/highlight.pack.js"></script>
<script src="/js/nav.js"></script>
<script>
    $(document).ready(function() {
        $('figure').each(function(i, block) {
            hljs.highlightBlock(block);
        });
    });
</script>
</div>
</body>
</html>